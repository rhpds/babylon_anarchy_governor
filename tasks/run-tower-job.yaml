---
- name: Report controller
  debug:
    msg:
    - "controller hostname: {{ controller.hostname }}"

- name: AWX organization {{ organization_name }}
  awx.awx.organization:
    name: "{{ organization_name }}"
    controller_host: "https://{{ controller.hostname }}/"
    controller_oauthtoken: "{{ controller.oauthtoken.token }}"
    validate_certs: false
  register: r_tower_organization

- name: AWX inventory {{ inventory_name }}
  awx.awx.inventory:
    name: "{{ inventory_name }}"
    controller_host: "https://{{ controller.hostname }}/"
    controller_oauthtoken: "{{ controller.oauthtoken.token }}"
    organization: "{{ organization_name }}"
    validate_certs: false

- name: AWX credentials
  loop: "{{ vault_credentials | default({}) | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  awx.awx.credential:
    name: "{{ organization_name }} {{ item.key }}"
    controller_host: "https://{{ controller.hostname }}/"
    controller_oauthtoken: "{{ controller.oauthtoken.token }}"
    credential_type: Vault
    inputs:
      vault_id: "{{ item.key }}"
      vault_password: "{{ item.value }}"
    organization: "{{ organization_name }}"
    validate_certs: false

- name: Set __project_scm_ref
  set_fact:
    __project_scm_ref: >-
      {{ __meta__.deployer.scm_ref | default(
        lookup('git_tag_prefix', __meta__.deployer.git_tag_prefix, git_repo=__meta__.deployer.scm_url)
        if __meta__.deployer.git_tag_prefix is defined else 'main'
      ) }}

- name: Set __project_name
  set_fact:
    __project_name: >-
      {{ organization_name }} {{ __meta__.deployer.scm_url }} ({{ __project_scm_ref }})

- name: AWX project
  awx.awx.project:
    name: "{{ __project_name }}"
    controller_host: "https://{{ controller.hostname }}/"
    controller_oauthtoken: "{{ controller.oauthtoken.token }}"
    scm_type: git
    scm_url: "{{ __meta__.deployer.scm_url }}"
    scm_branch: "{{ __project_scm_ref }}"
    scm_update_on_launch: >-
      {{ __project_scm_ref is not search('\d+\.\d+$') }}
    scm_update_cache_timeout: >-
      {{ __meta__.deployer.scm_update_cache_timeout | default(30) }}
    scm_clean: >-
      {{ __meta__.deployer.scm_clean | default(true) }}
    organization: "{{ organization_name }}"
    validate_certs: false

- name: Create Execution environment
  when:
    - ee | default({}, true) != {}
    - ee.image | default('') != ''
  vars:
    ee: "{{ execution_environment }}"
  awx.awx.execution_environment:
    organization: "{{ organization_name }}"
    controller_host: "https://{{ controller.hostname }}/"
    controller_oauthtoken: "{{ controller.oauthtoken.token }}"
    # TODO: change to true when SSL is valid
    validate_certs: false
    description: Automatically generated by babylon_anarchy_governor role
    image: "{{ ee.image }}"
    name: "{{ execution_environment_name }}"
    pull: "{{ ee.pull | default(omit, true) }}"
    # If ee is private, use the hostname of the image as the name of the credential
    # The credential must be created beforehand.
    credential: >-
      {%- if ee.private | default(false) -%}
      {{  (ee.image|default(omit)).split('/')[0] }}
      {%- else -%}
      {{ omit }}
      {%- endif -%}

- name: AWX Job Template block
  vars:
    __dynamic_credentials_query: >-
      [].key.join(' ', [`{{ organization_name | to_json }}`, @])
    __dynamic_credentials: >-
      {{ vault_credentials | default({}) | dict2items | to_json | from_json | json_query(__dynamic_credentials_query) }}
    __output_dir: /tmp/output-{{ vars.anarchy_subject.vars.job_vars.uuid }}
  block:
  - name: AWX Job Template {{ job_template_name }}
    awx.awx.job_template:
      name: "{{ job_template_name }}"
      # Need to use to_json | from_json to avoid AnsibleUnicode error on json_query
      credentials: "{{ __dynamic_credentials + static_credentials }}"
      custom_virtualenv: "{{ job_template_custom_virtualenv | default(omit, true) }}"
      execution_environment: "{{ execution_environment_name | default(omit, true) }}"
      extra_vars: >-
        {{ job_extra_vars
         | insert_unvault_string
         | combine(set_output_dir | bool | ternary({"output_dir": __output_dir}, {}))
         | combine({__meta__.deployer.scm_ref_var: __project_scm_ref} if __meta__.deployer.scm_ref_var is defined else {})
        }}
      playbook: "{{ job_template_playbook }}"
      project: "{{ __project_name }}"
      ask_inventory_on_launch: true
      controller_host: "https://{{ controller.hostname }}/"
      controller_oauthtoken: "{{ controller.oauthtoken.token }}"
      validate_certs: false
      timeout: "{{ job_template_timeout }}"
    register: r_job_template
    failed_when: r_job_template is failed and 'already exists' not in r_job_template.msg
  rescue:
  - name: AWX project update
    awx.awx.project_update:
      name: "{{ __project_name }}"
      organization: "{{ organization_name }}"
      controller_host: "https://{{ controller.hostname }}/"
      controller_oauthtoken: "{{ controller.oauthtoken.token }}"
      validate_certs: false

  - name: AWX Job Template {{ job_template_name }} (retry)
    awx.awx.job_template:
      name: "{{ job_template_name }}"
      # Need to use to_json | from_json to avoid AnsibleUnicode error on json_query
      credentials: "{{ __dynamic_credentials + static_credentials }}"
      custom_virtualenv: "{{ job_template_custom_virtualenv | default(omit, true) }}"
      execution_environment: "{{ execution_environment_name | default(omit, true) }}"
      extra_vars: >-
        {{ job_extra_vars
         | insert_unvault_string
         | combine(set_output_dir | bool | ternary({"output_dir": __output_dir}, {}))
         | combine({__meta__.deployer.scm_ref_var: __project_scm_ref} if __meta__.deployer.scm_ref_var is defined else {})
        }}
      playbook: "{{ job_template_playbook }}"
      project: "{{ __project_name }}"
      ask_inventory_on_launch: true
      controller_host: "https://{{ controller.hostname }}/"
      controller_oauthtoken: "{{ controller.oauthtoken.token }}"
      validate_certs: false
      timeout: "{{ job_template_timeout }}"
    register: r_job_template
    failed_when: r_job_template is failed and 'already exists' not in r_job_template.msg

- name: AWX Job Launch block
  block:
  - name: Launch Job {{ job_template_name }}
    awx.awx.job_launch:
      name: "{{ job_template_name }}"
      inventory: "{{ inventory_name }}"
      controller_host: "https://{{ controller.hostname }}/"
      controller_oauthtoken: "{{ controller.oauthtoken.token }}"
      validate_certs: false
    register: r_launch_job

  rescue:
  - name: AWX project update
    awx.awx.project_update:
      name: "{{ __project_name }}"
      organization: "{{ organization_name }}"
      controller_host: "https://{{ controller.hostname }}/"
      controller_oauthtoken: "{{ controller.oauthtoken.token }}"
      validate_certs: false

  - name: Launch Job {{ job_template_name }}
    awx.awx.job_launch:
      name: "{{ job_template_name }}"
      inventory: "{{ inventory_name }}"
      controller_host: "https://{{ controller.hostname }}/"
      controller_oauthtoken: "{{ controller.oauthtoken.token }}"
      validate_certs: false
    register: r_launch_job

- name: Set status in {{ anarchy_subject_name }}
  anarchy_subject_update:
    skip_update_processing: true
    metadata:
      labels:
        state: "{{ new_subject_state | default(current_state) }}"
    spec:
      vars:
        current_state: "{{ new_subject_state | default(current_state) }}"
        check_status_state: "{{ new_check_status_state | default(check_status_state) }}"
    status:
      actions:
        provision:
          startTimestamp: '{{ anarchy_run_timestamp }}'
      towerJobs: >-
        {{ {
           anarchy_action_config_name: {
             "deployerJob": r_launch_job.id,
             "startTimestamp": anarchy_run_timestamp,
             "completeTimestamp": None,
             "towerHost": controller.hostname,
             "towerJobURL": controller.hostname ~ "#/jobs/" ~ r_launch_job.id ~ "/"
           }
        } }}
...
